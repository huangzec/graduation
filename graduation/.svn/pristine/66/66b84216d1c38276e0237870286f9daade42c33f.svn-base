package com.mvc.controller;

import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.servlet.ModelAndView;

import com.mvc.common.Pagination;
import com.mvc.common.Verify;
import com.mvc.entity.Department;
import com.mvc.entity.Selectfirst;
import com.mvc.entity.Sontopic;
import com.mvc.entity.Tbtopic;
import com.mvc.service.SontopicService;
import com.mvc.service.TbtopicService;

/**
 * 课题
 * 
 * @author Happy_Jqc@163.com
 *
 */

@Controller
@RequestMapping(value="user/topic/")
public class TopicController {
	
	@Autowired
	private TbtopicService tbtopicService;
	
	@Autowired
	private SontopicService sontopicSercice;
	
	private Pagination pagination;
	
	private Integer pageNum = 1;
	
	private List<Tbtopic> topicList;
	
	public Pagination getPagination() {
		return pagination;
	}

	public void setPagination(Pagination pagination) {
		this.pagination = pagination;
	}

	public Integer getPageNum() {
		return pageNum;
	}

	public void setPageNum(Integer pageNum) {
		this.pageNum = pageNum;
	}

	public List<Tbtopic> getTopicList() {
		return topicList;
	}

	public void setTopicList(List<Tbtopic> topicList) {
		this.topicList = topicList;
	}

	/**
	 * 
	 * 进入课题课题页面 
	 * @Description  
	 * @author Happy_Jqc@163.com
	 * @date 2014-7-22 下午5:16:02
	 * @return ModelAndView
	 */
	@RequestMapping(value="intoSubmitTopic.do")
	public ModelAndView intoSubmitTopic(HttpServletRequest request, ModelMap modelMap){
		Integer userStatus = (Integer) request.getSession().getAttribute("user_status");
		if (userStatus == 1) {
			return new ModelAndView("user/student/submitTopic");
		} else {
			return new ModelAndView("user/teacher/submitTopic");
		}
	}
	
	/**
	 * 
	 * 教师课题提交方法 
	 * @Description  
	 * @author Happy_Jqc@163.com
	 * @date 2014-7-22 下午5:18:00
	 * @return ModelAndView
	 */
	@RequestMapping(value="tea_submitTopic.do")
	public ModelAndView tea_submitTopic(HttpServletRequest request, ModelMap modelMap){
		if(!this._verifyData(request)){
			return new ModelAndView("public/ajaxDone");
		}
		int topNum = Integer.parseInt(request.getParameter("topNum"));
		
		if(topNum== 2){
			if(!this._isExistStName(request,request.getParameter("sTName1")) 
					|| !this._isExistStName(request, request.getParameter("sTName2"))){
				return new ModelAndView("public/ajaxDone");
			}
		}
		if(topNum == 3){
			if(!this._isExistStName(request, request.getParameter("sTName3")) ||
				!this._isExistStName(request, request.getParameter("sTName4")) || 
				!this._isExistStName(request, request.getParameter("sTName5"))){
				return new ModelAndView("public/ajaxDone");
			}
		}
		if(topNum == 4){
			if(!this._isExistStName(request, request.getParameter("sTName6")) || 
				!this._isExistStName(request, request.getParameter("sTName7")) || 
				!this._isExistStName(request, request.getParameter("sTName8")) || 
				!this._isExistStName(request, request.getParameter("sTName9"))){
				return new ModelAndView("public/ajaxDone");
			}
		}
		
		String user_id = (String) request.getSession().getAttribute("user_id");
		Department dept = (Department) request.getSession().getAttribute("dept");
		
		Tbtopic topic = new Tbtopic();
		topic.setTopId(request.getParameter("topId"));
		topic.setTopName(request.getParameter("topName"));
		topic.setTopNumber(topNum);
		topic.setTopTec(request.getParameter("topTec"));
		topic.setTopStatus("0");
		topic.setTopCommitId(user_id);
		topic.setTopFlag("2");
		topic.setDeptId(dept.getDeptId());
		try{
			tbtopicService.save(topic);
			if(topNum == 2){
				this._saveSontopic(request, request.getParameter("sTName1"), topic.getTopTec(), topic);
				this._saveSontopic(request, request.getParameter("sTName2"), topic.getTopTec(), topic);
			}
			if(topNum == 3){
				this._saveSontopic(request, request.getParameter("sTName3"), topic.getTopTec(), topic);
				this._saveSontopic(request, request.getParameter("sTName4"), topic.getTopTec(), topic);
				this._saveSontopic(request, request.getParameter("sTName5"), topic.getTopTec(), topic);
			}
			if(topNum == 4){
				this._saveSontopic(request, request.getParameter("sTName6"), topic.getTopTec(), topic);
				this._saveSontopic(request, request.getParameter("sTName7"), topic.getTopTec(), topic);
				this._saveSontopic(request, request.getParameter("sTName8"), topic.getTopTec(), topic);
				this._saveSontopic(request, request.getParameter("sTName9"), topic.getTopTec(), topic);
			}
		}catch(Exception e){
			System.out.println(e.toString());
		}
		return new ModelAndView("public/ajaxDone");
	}
	
	/**
	 * 
	 * 学生提交课题 
	 * @Description  
	 * @author Happy_Jqc@163.com
	 * @date 2014-8-7 下午09:21:22
	 * @return ModelAndView
	 */
	@RequestMapping(value="stu_submitTopic.do")
	public ModelAndView stu_submitTopic(HttpServletRequest request, ModelMap modelMap){
		if(!this._verifyData(request)){
			return new ModelAndView("public/ajaxDone");
		}
		
		String user_id = (String) request.getSession().getAttribute("user_id");
		Department dept = (Department) request.getSession().getAttribute("dept");
		
		Tbtopic topic = new Tbtopic();
		topic.setTopId(request.getParameter("topId"));
		topic.setTopName(request.getParameter("topName"));
		topic.setTopNumber(1);
		topic.setTopTec(request.getParameter("topTec"));
		topic.setTopStatus("0");
		topic.setTopCommitId(user_id);
		topic.setTopFlag("1");
		topic.setDeptId(dept.getDeptId());
		try {
			tbtopicService.save(topic);
		} catch (Exception e) {
			System.out.println(e.toString());
		}
		return new ModelAndView("public/ajaxDone");
	}
	
	/**
	 * 
	 * 查看个人提交的课题 
	 * @Description  
	 * @author Happy_Jqc@163.com
	 * @date 2014-7-28 上午9:45:33
	 * @return ModelAndView
	 */
	@RequestMapping(value="lookTopic.do")
	public ModelAndView lookTopic(HttpServletRequest request, ModelMap modelMap){
		String username = (String) request.getSession().getAttribute("user_id");
		Integer userStatus = (Integer) request.getSession().getAttribute("user_status");
		
		if(!(request.getParameter("pageNum") == null))
		{
			pageNum = Integer.parseInt(request.getParameter("pageNum"));
		}
		System.out.println("pageNum =  " + pageNum);
		int size = 20;
		if(pagination == null){
			pagination = new Pagination(size);
		}
		pagination.setSize(size);
		pagination.setCurrentPage(pageNum);
		if(pagination.getCurrentPage() <= 0) {
			pagination.setCurrentPage(1);
		}
		if(pagination.getTotalPage() != 0 && pagination.getCurrentPage() > pagination.getTotalPage()) {
			pagination.setCurrentPage(pagination.getTotalPage());
		}
		String where = "from Tbtopic where topCommitId='" + username +"' order by topId asc";
		topicList = tbtopicService.getAllRecordByPages(where, pagination);
		if(topicList == null || topicList.size() < 1) {
			if (userStatus == 1) {
				return new ModelAndView("user/student/lookTopic");
			} else {
				return new ModelAndView("user/teacher/lookTopic");
			}
		}
		if(this.topicList.size() == 0 && pagination.getCurrentPage() != 1) {
			pagination.setCurrentPage(pagination.getCurrentPage() - 1);
			topicList = (List<Tbtopic>) tbtopicService.getAllRecordByPages(where, pagination);
		}
		modelMap.put("topicList", topicList);
		if (userStatus == 1) {
			return new ModelAndView("user/student/lookTopic");
		} else {
			return new ModelAndView("user/teacher/lookTopic");
		}
	}

	/**
	 * 
	 * TODO 
	 * @Description  
	 * @author Happy_Jqc@163.com
	 * @date 2014-8-10 下午05:27:34
	 * @return ModelAndView
	 */
	@RequestMapping(value="intoSelectTopic.do")
	public ModelAndView intoSelectTopid(){
		return new ModelAndView("user/student/selectTopic");
	}
	
	/**
	 * 
	 * TODO 学生选择课题 
	 * @Description  
	 * @author Happy_Jqc@163.com
	 * @date 2014-8-8 上午10:54:14
	 * @return ModelAndView
	 */
	@RequestMapping(value="selectTopic.do")
	public ModelAndView selectTopic(HttpServletRequest request, ModelMap modelMap){
		
		String username = (String) request.getSession().getAttribute("user_id");
		
		if(!(request.getParameter("pageNum") == null))
		{
			pageNum = Integer.parseInt(request.getParameter("pageNum"));
		}
		System.out.println("pageNum =  " + pageNum);
		int size = 20;
		if(pagination == null){
			pagination = new Pagination(size);
		}
		pagination.setSize(size);
		pagination.setCurrentPage(pageNum);
		if(pagination.getCurrentPage() <= 0) {
			pagination.setCurrentPage(1);
		}
		if(pagination.getTotalPage() != 0 && pagination.getCurrentPage() > pagination.getTotalPage()) {
			pagination.setCurrentPage(pagination.getTotalPage());
		}
		String where = "from Tbtopic where topCommitId='" + username +"' and topStatus='1' order by topId asc";
		topicList = tbtopicService.getAllRecordByPages(where, pagination);
		if(topicList == null || topicList.size() < 1) {
			return new ModelAndView("user/student/seletTopic");
		}
		if(this.topicList.size() == 0 && pagination.getCurrentPage() != 1) {
			pagination.setCurrentPage(pagination.getCurrentPage() - 1);
			topicList = (List<Tbtopic>) tbtopicService.getAllRecordByPages(where, pagination);
		}
		modelMap.put("topicList", topicList);
		return new ModelAndView("user/student/seletTopic");
	}
	
	/**
	 * 
	 *  判断子课题名称是否存在
	 * @Description  
	 * @author Happy_Jqc@163.com
	 * @date 2014-7-31 下午03:23:24
	 * @return boolean
	 */
	private boolean _isExistStName(HttpServletRequest request, String sTName) {
		List<Sontopic> sonTopicList = sontopicSercice.getAll("from Sontopic");
		for (int i = 0; i < sonTopicList.size(); i++) {
			if(sTName.equals(sonTopicList.get(i).getStName())){
				request.setAttribute("message", "子课题名称已存在！");
				return false;
			}
		}
		return true;
	}
	
	/**
	 * 
	 * 添加子课题记录 
	 * @Description  
	 * @author Happy_Jqc@163.com
	 * @param stTec 
	 * @date 2014-7-26 下午5:10:12
	 * @return void
	 */
	private void _saveSontopic(HttpServletRequest request, String stName, String stTec, Tbtopic tbtopic) {
		Sontopic s_topic = new Sontopic();
		s_topic.setStName(stName);
		s_topic.setTbtopic(tbtopic);
		s_topic.setStTec(stTec);
		try{
			sontopicSercice.save(s_topic);
		}catch(Exception e){
			System.out.println(e.toString());
		}
	}

	/**
	 * 
	 * 信息确认 
	 * @Description  
	 * @author Happy_Jqc@163.com
	 * @date 2014-7-24 上午11:24:05
	 * @return boolean
	 */
	private boolean _verifyData(HttpServletRequest request) {
		String topId = request.getParameter("topId");
		String topName = request.getParameter("topName");
		if(topId.equals("") || topId == null){
			request.setAttribute("message", "课题编号不能为空！");
			return false;
		}
		if(!this._isTopIdExist(topId)){
			request.setAttribute("message", "课题编号冲突！");
			return false;
		}
		if(topName.equals("") || topName == null){
			request.setAttribute("message", "课题名称不能为空！");
			return false;
		}
		if(!this._isTopNameExist(topName)){
			request.setAttribute("message", "课题名称冲突！");
			return false;
		}
		if( (Integer) request.getSession().getAttribute("user_status") == 2){
			String topNum = request.getParameter("topNum");
			if(topNum.equals("") || topNum == null){
				request.setAttribute("message", "请选择课题完成人数！");
				return false;
			}
		}
		return true;
	}

	/**
	 * 
	 * 判断课题是否已存在 
	 * @Description  
	 * @author Happy_Jqc@163.com
	 * @date 2014-7-24 上午11:44:19
	 * @return boolean
	 */
	private boolean _isTopNameExist(String topName) {
		List<Tbtopic> topicList = tbtopicService.getAll("from Tbtopic");
		for (int i = 0; i < topicList.size(); i++) {
			if (topicList.get(i).getTopName().equals(topName)) {
				return false;
			}
		}
		return true;
	}

	/**
	 * 
	 * 判断课题编号是否冲突 
	 * @Description  
	 * @author Happy_Jqc@163.com
	 * @date 2014-7-24 上午11:44:33
	 * @return boolean
	 */
	private boolean _isTopIdExist(String topId) {
		Tbtopic topic = new Tbtopic();
		topic = tbtopicService.getByTopId(topId);
		if(topic != null){
			return false;
		}
		return true;
	}
	
	/**
	 * 查看课题选择情况
	 *  
	 * @Description  
	 * @author huangzec@foxmail.com
	 * @date 2014-8-10 上午10:27:25
	 * @return ModelAndView
	 */
	@RequestMapping(value="/selectcase.do")
	public ModelAndView selectCase(HttpServletRequest request, ModelMap modelMap)
	{
		ModelAndView mav = new ModelAndView();
		mav.setViewName("user/teacher/selectcase-list");
		Department department = (Department) request.getSession().getAttribute("dept");
		String userId = (String) request.getSession().getAttribute("user_id");		
		if(!Verify.isEmpty(request.getParameter("pageNum")))
		{
			pageNum = Integer.parseInt(request.getParameter("pageNum"));
		}
		int size = 10;
		if(Verify.isEmpty(pagination)){
			pagination = new Pagination(size);
		}
		pagination.setSize(size);
		pagination.setCurrentPage(pageNum);
		if(pagination.getCurrentPage() <= 0) {
			pagination.setCurrentPage(1);
		}
		if(pagination.getTotalPage() != 0 && pagination.getCurrentPage() > pagination.getTotalPage()) {
			pagination.setCurrentPage(pagination.getTotalPage());
		}
		String where = "from Tbtopic where topCommitId='" + userId +"' AND topStatus = '1' AND deptId = '" + department.getDeptId() + "' order by topId asc";
		System.out.println("where " + where);
		topicList = tbtopicService.getAllRecordByPages(where, pagination);
		//System.out.println("select first " + topicList.get(0).getSelectFirst().iterator().next());
		if(Verify.isEmpty(topicList) || topicList.size() < 1) {
			System.out.println("is empty");
			return mav;
		}
		System.out.println("not empty");
		if(this.topicList.size() == 0 && pagination.getCurrentPage() != 1) {
			pagination.setCurrentPage(pagination.getCurrentPage() - 1);
			topicList = (List<Tbtopic>) tbtopicService.getAllRecordByPages(where, pagination);
		}
		System.out.println("put");
		modelMap.put("list", topicList);
		modelMap.put("pagination", pagination);
		System.out.println("return mav");
		
		return mav;
	}
	
}
